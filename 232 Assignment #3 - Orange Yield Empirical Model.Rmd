---
title: "Orange Yield Empirical Model"
author: "Hannah Garcia & Haley Grant"
date: "5/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# upload packages
library(raster)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(patchwork)
library(janitor)
library(ncdf4)
library(chron)
library(rgdal)
library(sf)
library(here)
```

```{r}
# read in function 
source("orange_yield.R")
```

```{r}
# read in data

all_climate <- read.csv("2578042.csv") # this data set contains data from three stations: Wiley Ridge CA, Oxnard CA, and Oxnard Weather Forecast Office, CA. All of these locations are in the general Oxnard area, which is an important agricultural region. Oranges are known to grow here or in the surrounding areas. 

# tidy data for function

all_climate_tidy <- all_climate %>% 
  clean_names() # all three locations combined, general oxnard area

max_temp <- all_climate_tidy %>% 
  select(date, tmax) # we don't need max temp for model

min_temp <- all_climate_tidy %>% 
  select(date, tmin) %>% # we need min temp for December from year before
  drop_na() %>% 
  group_by(date) %>%# average tmin for repeated dates
  summarize(tmin = mean(tmin)) %>% 
  mutate(month = month(date)) %>% 
  filter(month == "12") %>% # filter only the month of december
  mutate(year = year(date)) %>% 
  group_by(year) %>% 
  summarize(tmin_december = mean(tmin))

precip <- all_climate_tidy %>% 
  select(date, prcp) %>% # we need precip for May  
  drop_na() %>% 
  group_by(date) %>%# average precip for repeated dates
  summarize(prcp = mean(prcp)) %>% 
  mutate(month = month(date)) %>% 
  filter(month == "5") %>% # filter only the month of may
  mutate(year = year(date)) %>% 
  group_by(year) %>% 
  summarize(prcp_may = mean(prcp)) %>% 
  slice(2:20) # remove first year so we only use current year for precip and previous year for temp

```

```{r}
# test the model

result <- orange_anomaly(precip = precip$prcp_may, min_temp = min_temp$tmin_december)
head(result)

```



```{r}
# filename for data
ncname20th <- "b.e11.B20TRC5CNBDRD.f09_g16.102.cam.h0.TS.199001-200512"  
ncfname20th <- paste(ncname20th, ".nc", sep="")
ncname21st <- "b.e11.BRCP85C5CNBDRD.f09_g16.102.cam.h0.TS.208501-210012"  
ncfname21st <- paste(ncname21st, ".nc", sep="")
dname <- "TS"  # this is the name of the variable you want to look at

ncin <- nc_open(ncfname20th)
ncin21st <- nc_open(ncfname21st)

lon <- ncvar_get(ncin,"lon")
nlon <- dim(lon)
lat <- ncvar_get(ncin,"lat")
nlat <- dim(lat)

# Time coordinate for 20th century part of run
time20th <- ncvar_get(ncin,"time")
tunits20th <- ncatt_get(ncin,"time","units")
origin="1/15/1990"
enddate="12/15/2005"
rtime20th <- seq.dates(origin, enddate, by="months")

# Time coordinate for 21st century part of run
origin="1/15/2085"
enddate="12/15/2100"
rtime21st <- seq.dates(origin, enddate, by="months")
```



```{r}
TS20th <- ncvar_get(ncin, "TS")-273.15
TS21st <- ncvar_get(ncin21st, "TS")-273.15

lats=which(lat >= 32 & lat <= 35)
lons=which(lon >= 241 & lon <= 243)

# Regional minimum temperature
tsmin20th <- apply(TS20th[lons,lats,],3,min)
tsmin21st <- apply(TS21st[lons,lats,],3,min)

# Make data frame, store the month of year in the data frame along with temperature information
clim20th <- data.frame(time=rtime20th, tsmin=tsmin20th)
clim20th$season = month(rtime20th)
clim21st <- data.frame(time=rtime21st, tsmin=tsmin21st)
clim21st$season = month(rtime21st)

# Get December values only for minimum temperature
decclim20th = subset(clim20th, clim20th$season==12)
decclim20th$dt = unique(year(rtime20th))
decclim21st = subset(clim21st, clim21st$season==12)
decclim21st$dt = unique(year(rtime21st))

# Apply empirical model: assume no change in efficiency below 15C, -1%/degree C above
fac20=ifelse(decclim20th$tsmin-15 < 0,0,(decclim20th$tsmin-15)*-0.01)+1
fac21=ifelse(decclim21st$tsmin-15 < 0,0,(decclim21st$tsmin-15)*-0.01)+1

# Effect of climate change = ratio of efficiency factors for 21st, 20th century periods
ccfac=mean(fac21)/mean(fac20)
print(ccfac)
```

## Read in Cal-Adapt Data
```{r}
require(raster)
library(here)
library(dplyr)

## ------------------------------------------------------------------------------------
# Precip: read in raster files and convert to points
precip <- list.files(path = here("caladapt_data", "precip"), full.names = TRUE)

prcp_raster <- raster::stack(precip) 

prcp_df <- raster::rasterToPoints(prcp_raster) %>% 
  as.data.frame()

# remove first part of the column names so it is just the date
names(prcp_df) = gsub(pattern = "prcp_flx_ccsm3a2bcsd_", replacement = "", x = names(prcp_df))

# next step is to only keep May precip. UGH this'll be hard (need some time to figure this out)
# precip_tidy <- prcp_df %>% 
#   select(prcp_df, dplyr::contains("05")) - didn't work. I wonder if it's ok to get rid of the  x & y? we're not doing spatial?

## ---------------------------------------------------------------------------------------
# Tmin
tmin <- list.files(path = here("caladapt_data", "tmin"), full.names = TRUE)

tmin_raster <- raster::stack(tmin) 

tmin_df <- raster::rasterToPoints(tmin_raster) %>% 
  as.data.frame()

names(tmin_df) = gsub(pattern = "tmin_inf_ccsm3a2bcsd_", replacement = "", x = names(tmin_df))

# Filter for just December  
```

